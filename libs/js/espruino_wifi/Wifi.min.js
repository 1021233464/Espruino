function y(a){return{ip:a.charCodeAt(0)+"."+a.charCodeAt(1)+"."+a.charCodeAt(2)+"."+a.charCodeAt(3),port:a.charCodeAt(5)<<8|a.charCodeAt(4),len:a.charCodeAt(7)<<8|a.charCodeAt(6)}}function C(a){var b=a.indexOf(":");if(0>b)return a;var c=a.substring(5,b).split(",");c[1]|=0;var d=a.length-(b+1),e=c[0];if(t[e]){var l=(c[2]||"0.0.0.0").split(".").map(function(a){return 0|a}),z=0|c[3];g[e]+=String.fromCharCode(l[0],l[1],l[2],l[3],z&255,z>>8,d&255,d>>8)}if(d>=c[1])return g[e]+=a.substr(b+1,
c[1]),a.substr(b+c[1]+1);g[e]+=a.substr(b+1,d);f.getData(c[1]-d,function(a){g[e]+=a});return""}function u(a,b){if(b)return a(b);f.cmd("AT+CWMODE="+m+"\r\n",1E3,function(b){"no change"!=b&&"OK"!=b&&"WIFI DISCONNECT"!=b?a("CWMODE failed: "+(b?b:"Timeout")):a(null)})}function n(a){var b=a[0];void 0===e[b]&&e[5]?e[b]="Accept":"Wait"==e[b]?e[b]=!0:f.cmd("AT+CIPCLOSE="+b+"\r\n",1E3,function(a){e[b]=void 0})}function p(a){e[a[0]]=""!=g[a[0]]?"DataClose":void 0}function r(a,b){var c=0==m;m|=a;c?("1v91"==
process.version?(v.reset(),q.setup(115200,{rx:A3,tx:A2})):q.setup(115200,{rx:A3,tx:A2,cts:v}),f=require("AT").connect(q),f.register("+IPD",C),f.registerLine("0,CONNECT",n),f.registerLine("1,CONNECT",n),f.registerLine("2,CONNECT",n),f.registerLine("3,CONNECT",n),f.registerLine("4,CONNECT",n),f.registerLine("0,CLOSED",p),f.registerLine("1,CLOSED",p),f.registerLine("2,CLOSED",p),f.registerLine("3,CLOSED",p),f.registerLine("4,CLOSED",p),f.registerLine("WIFI CONNECTED",function(){w=!0;exports.emit("associated")}),
f.registerLine("WIFI GOT IP",function(){exports.emit("connected")}),f.registerLine("WIFI DISCONNECTED",function(){w=!1;exports.emit("disconnected")}),exports.at=f,require("NetworkJS").create(A),f.cmd("\r\nAT+RST\r\n",1E4,function l(a){if("ready"==a||"Ready."==a)setTimeout(function(){f.cmd("ATE0\r\n",1E3,function D(a){if("ATE0"==a)return D;"OK"==a?f.cmd("AT+CIPDINFO=1\r\n",1E3,function(a){if("OK"!=a)return b("CIPDINFO failed: "+(a?a:"Timeout"));f.cmd("AT+CIPMUX=1\r\n",1E3,function(a){if("OK"!=a)return b("CIPMUX failed: "+
(a?a:"Timeout"));f.cmd("AT+UART_CUR=115200,8,1,0,2\r\n",500,function(a){if("OK"!=a)return b("UART_CUR failed: "+(a?a:"Timeout"));u(b)})})}):b("ATE0 failed: "+(a?a:"Timeout"))})},500);else if(void 0===a)b("No 'ready' after AT+RST");else return l}),digitalWrite(F,1),digitalWrite(x,1)):u(b)}function B(a){(m&=~a)?u(function(){},null):(q.removeAllListeners(),f=void 0,exports.at=void 0,digitalWrite(x,0),e=[])}var F=A13,x=A14,v=A15,q=Serial2;digitalWrite(x,0);var G=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],
m=0,w=!1,f,e=[],t=[],g=["","","","",""],A={create:function(a,b,c){if(!f||!w)return-1;if(void 0===a&&2!=c)return d=5,e[d]="Wait",g[d]="",f.cmd("AT+CIPSERVER=1,"+b+"\r\n",1E4,function(a){"OK"==a?e[d]=!0:(e[d]=void 0,setTimeout(function(){throw Error("CIPSERVER failed ("+(a?a:"Timeout")+")");},0))}),5;for(var d=0;void 0!==e[d];)d++;if(5<=d)return-7;g[d]="";e[d]="Wait";var h;2==c?(b?h="AT+CIPSTART="+d+',"UDP","255.255.255.255",'+b+","+b+",2\r\n":e[d]="UDP",t[d]=!0):(h="AT+CIPSTART="+d+',"TCP",'+JSON.stringify(a)+
","+b+"\r\n",delete t[d]);h&&f.cmd(h,1E4,function k(a){if("ALREADY CONNECTED"==a)return k;if("OK"!=a||!0!==e[d])e[d]=-6});return d},close:function(a){"Wait"==e[a]?e[a]="WaitClose":void 0!==e[a]&&(0>e[a]||"UDP"==e[a]?e[a]=void 0:f.cmd((5==a?"AT+CIPSERVER=0":"AT+CIPCLOSE="+a)+"\r\n",1E3,function(b){e[a]=void 0}))},accept:function(a){for(a=0;5>a;a++)if("Accept"==e[a])return e[a]=!0,a;return-1},recv:function(a,b,c){return g[a]?(g[a].length>b?(c=g[a].substr(0,b),g[a]=g[a].substr(b)):(c=g[a],g[a]="","DataClose"==
e[a]&&(e[a]=void 0)),c):0>e[a]?e[a]:e[a]?"":-1},send:function(a,b,c){if(!f)return-1;if(f.isBusy()||"Wait"==e[a])return 0;if(0>e[a])return e[a];if(!e[a])return-1;if("UDP"==e[a])return c=y(b),e[a]="Wait",f.cmd("AT+CIPSTART="+a+',"UDP","'+c.ip+'",'+c.port+","+c.port+",2\r\n",1E4,function(b){"OK"!=b&&(e[a]=-6)}),0;var d=b.length,h="";2==c&&(c=y(b),h=',"'+c.ip+'",'+c.port,b=b.substr(8,c.len),d=8+c.len);f.cmd("AT+CIPSEND="+a+","+b.length+h+"\r\n",1E4,function k(d){if("OK"==d)return f.register("> ",function(){f.unregister("> ");
f.write(b);return""}),k;if(d=="Recv "+b.length+" bytes"||"busy s..."==d)return k;"SEND OK"==d?("WaitClose"==e[a]&&A.close(a),e[a]=!0):(e[a]=void 0,f.unregister("> "))});e[a]="Wait";return d}};exports.connect=function(a,b,c){var d="";c=c||function(){};void 0!==b.password&&(d=b.password);r(1,function(b){if(b)return c(b);f.cmd("AT+CWJAP="+JSON.stringify(a)+","+JSON.stringify(d)+"\r\n",2E4,function k(a){if(0<=["WIFI DISCONNECT","WIFI CONNECTED","WIFI GOT IP","+CWJAP:1"].indexOf(a))return k;"OK"!=a?setTimeout(c,
0,"WiFi connect failed: "+(a?a:"Timeout")):setTimeout(c,0,null)})})};exports.disconnect=function(){B(1)};exports.startAP=function(a,b,c){b=b||{};if(!b.password||8>b.password.length)throw Error("Password must be at least 8 characters");var d=b.password?"3":"0";if(b.authMode&&(d={open:0,wpa:2,wpa2:3,wpa_wpa2:4}[b.authMode],void 0===d))throw Error("Unknown authMode "+b.authMode);void 0===b.channel&&(b.channel=5);r(2,function(e){if(e)return c(e);f.cmd("AT+CWSAP="+JSON.stringify(a)+","+JSON.stringify(b.password)+
","+b.channel+","+d+"\r\n",5E3,function(a){"OK"!=a?c("CWSAP failed: "+(a?a:"Timeout")):c(null)})})};exports.stopAP=function(){B(2)};exports.scan=function(a){var b=[];r(1,function(c){if(c)return a(c);f.cmdReg("AT+CWLAP\r\n",5E3,"+CWLAP:",function(a){a=a.slice(8,-1).split(",");b.push({ssid:JSON.parse(a[1]),authMode:G[a[0]],rssi:parseInt(a[2]),mac:JSON.parse(a[3]),channel:JSON.parse(a[4])})},function(d){a(null,b)})})};exports.getIP=function(a){var b={};f.cmd("AT+CIFSR\r\n",1E3,function h(d){if(void 0===
d)a("Timeout");else{if("+CIFSR:STAIP"==d.substr(0,12))b.ip=d.slice(14,-1);else if("+CIFSR:STAMAC"==d.substr(0,13))b.mac=d.slice(15,-1);else if("OK"==d){a(null,b);return}return h}})};exports.setIP=function(a,b){if("object"==typeof a&&a.ip){var c=[JSON.stringify(a.ip)];a.gateway&&(c.push(JSON.stringify(a.gateway)),c.push(JSON.stringify(a.netmask||"255.255.255.0")));c="AT+CIPSTA_CUR="+c.join(",")+"\r\n";var d=3E3}else c="AT+CWDHCP_CUR=1,1\r\n",d=2E4;f.cmd(c,d,function(a){if("OK"==a)b(null);else return b("setIP failed: "+
(a?a:"Timeout"))})};exports.getAPIP=function(a){var b={};f.cmd("AT+CIPAP_CUR?\r\n",1E3,function h(d){if(void 0===d)a("Timeout");else if("OK"==d)f.cmd("AT+CIPAPMAC_CUR?\r\n",1E3,function k(d){if(void 0===d)a("Timeout");else if("OK"==d)a(null,b);else return"+CIPAPMAC_CUR"==d.substr(0,14)&&(b.mac=JSON.parse(d.substr(10))),k});else return"+CIPAP_CUR"==d.substr(0,10)&&(d=d.split(":"),b[d[1]]=JSON.parse(d[2])),h})};exports.setAPIP=function(a,b){var c=[JSON.stringify(a.ip)];a.gateway&&(c.push(JSON.stringify(a.gateway)),
c.push(JSON.stringify(a.netmask||"255.255.255.0")));f.cmd("AT+CIPAP_CUR="+c.join(",")+"\r\n",3E3,function(a){if("OK"==a)b(null);else return b("setAPIP failed: "+(a?a:"Timeout"))})};exports.setHostname=function(a,b){r(1,function(c){if(c)return b(c);f.cmd("AT+CWHOSTNAME="+JSON.stringify(a)+"\r\n",500,b)})};exports.ping=function(a,b){var c;f.cmd('AT+PING="'+a+'"\r\n',1E3,function l(a){if(a&&"+"==a[0])return c=a.substr(1),l;"OK"==a?b(c):b()})};exports.turbo=function(a,b){var c=a?!0===a?921600:a:115200;
f.cmd("AT+UART_CUR="+c+",8,1,0,2\r\n",500,function(a){"OK"!=a?b&&b("Baud rate switch to "+c+" failed: "+(a?a:"Timeout")):(q.setup(c,{rx:A3,tx:A2,cts:v}),b&&b(null))})};exports.debug=function(){return{wifiMode:m,socks:e,sockData:g}}