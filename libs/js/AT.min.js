exports.connect=function(p){var n=!1,b="",g,d=0,m,e={},k={},l=[];p.on("data",function q(a){if(d){b&&(a=b+a,b="");if(a.length<=d){d-=a.length;m(a);0==d&&(m=void 0);return}m(a.substr(0,d));a=a.substr(d);d=0;m=void 0}b+=a;n&&console.log("] "+JSON.stringify(a));if(e)for(var c in e)for(var h;h!=b&&b.substr(0,c.length)==c;)h=b,b=e[c](b);for(a=b.indexOf("\r\n");0<=a;){h=b.substr(0,a);var f=!1;if(0<h.length){for(c in k)h.substr(0,c.length)==c&&(k[c](h),f=!0);f||g&&g(h)}b=b.substr(a+2);if(f&&d)return q("");
if(b.length&&e)for(c in e)b.substr(0,c.length)==c&&(b=e[c](b));a=b.indexOf("\r\n")}});var f={debug:function(a){n=!1!==a;return{line:b,lineCallback:g,handlers:e,lineHandlers:k,waiting:l,dataCount:d}},cmd:function(a,b,c){if(g)n&&console.log("Queued "+JSON.stringify(a)),l.push([a,b,c]);else if(n&&console.log("["+JSON.stringify(a)),p.write(a),b){var d=setTimeout(function(){g=void 0;c&&c();void 0===g&&0<l.length&&f.cmd.apply(f,l.shift())},b),e=function(a){g=void 0;var b;c&&(b=c(a))?(g=e,c=b):clearTimeout(d);
void 0===g&&0<l.length&&f.cmd.apply(f,l.shift())};g=e}},write:function(a){p.write(a)},cmdReg:function(a,b,c,d,e){f.registerLine(c,d);f.cmd(a,b,function(a){f.unregisterLine(c);e(a)})},registerLine:function(a,b){if(k[a])throw Error(a+" already registered");k[a]=b},unregisterLine:function(a){delete k[a]},register:function(a,b){if(e[a])throw Error(a+" already registered");e[a]=b},unregister:function(a){delete e[a]},isBusy:function(){return void 0!==g},getData:function(a,b){if(d)throw Error("Already grabbing data");
d=a;m=b}};return f}